<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERDucate Progress & Certificates</title>
<link rel="icon" href="ERDucate.ico">
<style>
 body { 
  font-family: Arial, sans-serif; 
  margin: 20px; 
  text-align: center; 
  background:#f9f9f9; 
}
.topic { 
  border: 1px solid #ccc; 
  border-radius: 8px; 
  padding: 15px; 
  margin: 15px auto; 
  width: 60%; 
  background:#fff; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
}
.done { 
  color: green; 
  font-weight: bold; 
}
.notdone { 
  color: red; 
}
.btn { 
  padding: 10px 20px; 
  margin-top: 10px; 
  border: none; 
  border-radius: 5px; 
  background: maroon; 
  color: #fff; 
  cursor: pointer; 
}
.btn:hover { 
  background: #a00000; 
}
canvas { 
  display: none; 
  border: 2px solid maroon; 
  margin: 20px auto; 
}

/* ---------------------- */
/* RESPONSIVENESS SECTION */
/* ---------------------- */

/* For laptops & small desktops */
@media (max-width: 1024px) {
  .topic {
    width: 70%;
  }
}

/* For tablets */
@media (max-width: 768px) {
  body {
    margin: 15px;
  }
  .topic {
    width: 80%;
    padding: 12px;
  }
  .btn {
    padding: 8px 16px;
    font-size: 0.95rem;
  }
}

/* For mobile phones */
@media (max-width: 480px) {
  body {
    margin: 10px;
    font-size: 0.95rem;
  }
  .topic {
    width: 95%;
    padding: 10px;
    margin: 10px auto;
    border-radius: 6px;
  }
  .btn {
    width: 100%;
    padding: 10px;
    font-size: 0.9rem;
  }
  canvas {
    width: 100%;
    max-width: 300px;
  }
}
</style>
</head>
<body>

<h1>My Progress & Certificates</h1>
<p id="studentName"></p>
<div id="progressList"></div>

<canvas id="certCanvas" width="800" height="600"></canvas>

<button class="btn" onclick="window.location.href='index.html'">Back to Homepage</button>

<script>
// ===== Topics =====
const topics = [
  "Introduction to Databases & Importance of Structuring",
  "Basic Concepts of Database Structure",
  "Identifying Entities & Attributes",
  "Table Structures & Keys",
  "Table Relationships",
  "Data Types & Designing the ERD",
  "Normalization & Database Design",       
  "Introduction to SQL & Querying Databases" 
];

// ===== Initialize users if missing =====
function initUsers() {
  if (!localStorage.getItem("users")) {
    const demoUsers = { "DemoUser": { progress: {} } };
    topics.forEach((t,i)=>{
      demoUsers["DemoUser"].progress[`lesson${i+1}`] = false;
      demoUsers["DemoUser"].progress[`quiz${i+1}`] = false;
      demoUsers["DemoUser"].progress[`game${i+1}`] = false;
      demoUsers["DemoUser"].progress[`achievement${i+1}`] = false;
    });
    localStorage.setItem("users", JSON.stringify(demoUsers));
    localStorage.setItem("loggedInUser", "DemoUser");
  }
}

// ===== Load current user =====
function loadCurrentUser() {
  const users = JSON.parse(localStorage.getItem("users")) || {};
  const currentUser = localStorage.getItem("loggedInUser");
  if (!currentUser || !users[currentUser]) return null;
  return { users, currentUser, progress: users[currentUser].progress };
}

// ===== Central function to update progress =====
function updateProgress(type, topicNum, value=true) {
  const data = loadCurrentUser();
  if(!data) return;
  data.users[data.currentUser].progress[`${type}${topicNum}`] = value;
  localStorage.setItem("users", JSON.stringify(data.users));
  renderProgress(); // Refresh display
}

// ===== Render progress list =====
function renderProgress() {
  const data = loadCurrentUser();
  if(!data) {
    document.body.innerHTML = "<h2>No user found. Please login again.</h2><a href='index.html'>Go to Homepage</a>";
    return;
  }

  const { currentUser, progress } = data;
  document.getElementById("studentName").textContent = `Student: ${currentUser}`;
  const list = document.getElementById("progressList");
  list.innerHTML = "";

  topics.forEach((topic,i)=>{
    const lesson = progress[`lesson${i+1}`];
    const quiz = progress[`quiz${i+1}`];
    const game = progress[`game${i+1}`];
    const achievement = progress[`achievement${i+1}`];
    const completed = lesson && quiz && game;

    const topicDiv = document.createElement("div");
    topicDiv.className = "topic";
    topicDiv.innerHTML = `
      <h2>Topic ${i+1}: ${topic}</h2>
      <p>Lesson: <span class="${lesson?'done':'notdone'}">${lesson?'‚úÖ Completed':'‚ùå Not Completed'}</span></p>
      <p>Quiz: <span class="${quiz?'done':'notdone'}">${quiz?'‚úÖ Completed':'‚ùå Not Completed'}</span></p>
      <p>Game: <span class="${game?'done':'notdone'}">${game?'‚úÖ Completed':'‚ùå Not Completed'}</span></p>
      <p>Achievement: <span class="${achievement?'done':'notdone'}">${achievement?'üèÜ Certificate Downloaded':'‚ùå Locked'}</span></p>
    `;

    if(completed && !achievement){
      const certBtn = document.createElement("button");
      certBtn.className = "btn";
      certBtn.textContent = `Download Certificate for Topic ${i+1}`;
      certBtn.onclick = () => generateCert(i+1);
      topicDiv.appendChild(certBtn);
    } else if(!completed){
      const note = document.createElement("p");
      note.className = "notdone";
      note.textContent = "üìå Finish Lesson, Quiz, and Game to unlock certificate.";
      topicDiv.appendChild(note);
    }

    list.appendChild(topicDiv);
  });
}

// ===== Certificate Generation =====
async function generateCert(topicNum) {
  const data = loadCurrentUser();
  if(!data) return;
  const { users, currentUser } = data;

  users[currentUser].progress[`achievement${topicNum}`] = true;
  localStorage.setItem("users", JSON.stringify(users));

  renderProgress();

  const canvas = document.getElementById("certCanvas");
  const ctx = canvas.getContext("2d");
  canvas.style.display = "block";

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#f8f8f8"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = "maroon"; ctx.lineWidth = 10; ctx.strokeRect(20,20,canvas.width-40,canvas.height-40);

  ctx.fillStyle = "maroon"; ctx.font="40px Arial"; ctx.textAlign="center";
  ctx.fillText("CERTIFICATE OF APPRECIATION", canvas.width/2, 120);

  ctx.fillStyle = "black"; ctx.font="22px Arial";
  ctx.fillText("This Certificate is proudly presented to", canvas.width/2, 180);

  ctx.font="bold 32px Arial";
  ctx.fillText(currentUser, canvas.width/2, 240);

  ctx.font="28px Arial"; ctx.fillStyle="maroon";
  ctx.fillText(topics[topicNum-1], canvas.width/2, 300);

  ctx.font="18px Arial"; ctx.fillStyle="black";
  const message = "in recognition of outstanding performance, dedication, and commitment.\n" +
                  "Your perseverance and excellence have brought great credit to yourself \n" +
                  "and serve as an inspiration.\n\n" +
                  "Congratulations on this remarkable achievement! \nBy the developer";
  message.split("\n").forEach((line, idx)=>ctx.fillText(line, canvas.width/2, 360+idx*28));

  ctx.font="16px Arial";
  ctx.fillText(`Date: ${new Date().toLocaleDateString()}`, canvas.width/2, 520);

  const dataURL = canvas.toDataURL("image/png");

  // ‚úÖ Fix for Mobile Download / Share
  if (navigator.canShare && navigator.canShare({ files: [] })) {
    const response = await fetch(dataURL);
    const blob = await response.blob();
    const file = new File([blob], `${topics[topicNum-1]}_Certificate.png`, { type: "image/png" });
    await navigator.share({
      files: [file],
      title: "Your Certificate",
      text: "Download or share your certificate."
    }).catch(err => console.log("Share cancelled", err));
  } else {
    const link = document.createElement("a");
    link.download = `${topics[topicNum-1]}_Certificate.png`;
    link.href = dataURL;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

// ===== Init =====
initUsers();
renderProgress();
</script>
</body>
</html>
